"""
Universal Vulnerability Detection Helper
Provides standardized detection for payloadDetected/injectionDetected/vulnerability fields
"""

import json
from typing import Dict, Any, Optional
from loguru import logger


def check_vulnerability_indicators(
    response_text: str,
    vulnerability_types: list,
    url: str = "",
    payload: Any = None
) -> Optional[Dict[str, Any]]:
    """
    Universal helper to check for vulnerability indicators in response
    
    Args:
        response_text: Raw response text from target
        vulnerability_types: List of vulnerability type keywords to check for
        url: Request URL
        payload: The payload that was sent
        
    Returns:
        Vulnerability dict if detected, None otherwise
    """
    try:
        # Try to parse as JSON
        try:
            json_data = json.loads(response_text)
        except:
            return None
        
        if not isinstance(json_data, dict):
            return None
        
        # Check for explicit payload/injection detected
        if json_data.get('payloadDetected') or json_data.get('injectionDetected'):
            logger.info(f"ðŸŽ¯ Vulnerability confirmed via payloadDetected field!")
            
            # Determine vulnerability type from response
            vuln_type = "Unknown"
            severity = "HIGH"
            
            vuln_field = str(json_data.get('vulnerability', '')).lower()
            for v_type in vulnerability_types:
                if v_type.lower() in vuln_field:
                    vuln_type = v_type
                    break
            
            return {
                "vulnerability_type": vuln_type.lower().replace(" ", "_"),
                "type": vuln_type,
                "severity": "CRITICAL" if json_data.get('payloadDetected') else "HIGH",
                "url": url,
                "payload": str(payload) if payload else "",
                "evidence": f"Target confirmed: {json_data}",
                "title": f"{vuln_type} detected",
                "description": f"{vuln_type} vulnerability confirmed by target response",
                "cwe": "CWE-GENERIC",
                "method": "POST" if payload else "GET"
            }
        
        # Check for vulnerability field
        if 'vulnerability' in json_data:
            vuln_field = str(json_data.get('vulnerability', '')).lower()
            
            # Check if any of our vulnerability types match
            for v_type in vulnerability_types:
                if v_type.lower() in vuln_field:
                    logger.info(f"ðŸŽ¯ {v_type} vulnerability field detected!")
                    
                    return {
                        "vulnerability_type": v_type.lower().replace(" ", "_"),
                        "type": v_type,
                        "severity": "HIGH",
                        "url": url,
                        "payload": str(payload) if payload else "",
                        "evidence": f"Vulnerability: {json_data.get('vulnerability')}",
                        "title": f"{v_type} in {url}",
                        "description": f"{v_type} vulnerability detected",
                        "cwe": "CWE-GENERIC",
                        "method": "POST" if payload else "GET"
                    }
        
        return None
        
    except Exception as e:
        logger.debug(f"Vulnerability indicator check error: {e}")
        return None


# Pre-defined vulnerability type mappings for common agents
VULNERABILITY_TYPES = {
    'template': ['Template Injection', 'SSTI', 'Server-Side Template Injection'],
    'xxe': ['XXE', 'XML External Entity', 'XML Injection'],
    'ssrf': ['SSRF', 'Server-Side Request Forgery'],
    'file_upload': ['File Upload', 'Unrestricted Upload', 'Malicious Upload'],
    'business_logic': ['Business Logic', 'Price Manipulation', 'Race Condition', 'Auth Bypass'],
    'deserialization': ['Deserialization', 'Insecure Deserialization'],
    'ldap': ['LDAP Injection', 'LDAP'],
    'lfi': ['LFI', 'Local File Inclusion', 'Path Traversal', 'File Inclusion'],
    'nosql': ['NoSQL Injection', 'NoSQL', 'MongoDB Injection'],
}




